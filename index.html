<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Daily Delivery</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            background-color: #f5f7f9;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .container {
            display: flex;
            flex: 1;
        }
        /* Sidebar Filter */
        .sidebar {
            width: 300px;
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            padding: 20px;
            transition: all 0.3s ease;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        .sidebar.collapsed {
            transform: translateX(-250px);
            width: 50px;
        }
        .sidebar-toggle {
            position: absolute;
            top: 15px;
            right: -40px;
            background: #2c3e50;
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 0 5px 5px 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }
        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 5px;
        }
        .sidebar-content::-webkit-scrollbar {
            width: 5px;
        }
        .sidebar-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }
        .sidebar-content::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        .filter-group {
            margin-bottom: 25px;
        }
        .filter-group h3 {
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 8px;
            display: flex;
            align-items: center;
        }
        .filter-group h3 i {
            margin-right: 10px;
        }
        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }
        .filter-group input {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            margin-bottom: 10px;
            background: white;
            color: #333;
        }
        .custom-dropdown {
            position: relative;
            width: 100%;
            margin-bottom: 10px;
        }
        .dropdown-selected {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background: white;
            color: #333;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .dropdown-selected i {
            color: #7f8c8d;
        }
        .dropdown-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        .dropdown-options.show {
            display: block;
        }
        .dropdown-option {
            padding: 10px;
            cursor: pointer;
            color: #333;
            border-bottom: 1px solid #eee;
        }
        .dropdown-option:hover {
            background: #f8f9fa;
        }
        .dropdown-option:last-child {
            border-bottom: none;
        }
        .dropdown-option.selected {
            background: #e3f2fd;
            font-weight: bold;
        }
        .file-upload {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
        }
        .file-upload-btn {
            display: inline-block;
            padding: 10px 15px;
            background: #3498db;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        .file-upload-btn:hover {
            background: #2980b9;
        }
        .main-content {
            flex: 1;
            padding: 20px;
            transition: all 0.3s ease;
        }
        .header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
            padding: 20px;
            border-bottom: 1px solid #ddd;
            background: linear-gradient(135deg, #3498db, #2c3e50);
            color: white;
            border-radius: 10px;
            text-align: center;
            position: relative;
        }
        .header-content {
            text-align: center;
        }
        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }
        .header-info {
            margin-top: 10px;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }
        .header-info div {
            margin-bottom: 5px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 5px;
        }
        .kpi-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .kpi-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            text-align: center;
            transition: transform 0.3s ease;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        }
        .kpi-card h3 {
            font-size: 16px;
            color: #7f8c8d;
            margin-bottom: 10px;
        }
        .kpi-card .value {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
        }
        .kpi-card .subtitle {
            font-size: 12px;
            color: #95a5a6;
            margin-top: 5px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #7f8c8d;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            flex: 1;
            justify-content: center;
        }
        .tab i {
            margin-right: 8px;
        }
        .tab.active {
            background: #3498db;
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        .chart-title {
            font-size: 18px;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        .chart-title i {
            margin-right: 10px;
            color: #3498db;
        }
        .chart-wrapper {
            position: relative;
            height: 350px;
        }
        .section-title {
            font-size: 20px;
            color: #2c3e50;
            margin: 25px 0 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
            display: flex;
            align-items: center;
        }
        .section-title i {
            margin-right: 10px;
            color: #3498db;
        }
        .footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: #7f8c8d;
            font-size: 14px;
            border-top: 1px solid #ddd;
        }
        @media (max-width: 992px) {
            .container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                height: auto;
            }
            .sidebar.collapsed {
                transform: translateX(0);
                width: 100%;
                height: 60px;
                overflow: hidden;
            }
            .kpi-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            .header-info {
                flex-direction: column;
                gap: 10px;
            }
        }
        @media (max-width: 576px) {
            .kpi-cards {
                grid-template-columns: 1fr;
            }
            .header {
                padding: 15px;
            }
            .header h1 {
                font-size: 24px;
            }
            .tabs {
                flex-direction: column;
            }
        }
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
        }
        .empty-state i {
            font-size: 48px;
            margin-bottom: 15px;
            color: #bdc3c7;
        }
        .empty-state p {
            font-size: 18px;
        }
        .debug-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 5px;
            padding: 10px;
            margin: 10px 0;
            font-size: 12px;
            display: none;
        }
        .single-option-notice {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
            font-style: italic;
        }
        .no-data-message {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-style: italic;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar Filter -->
        <div class="sidebar" id="sidebar">
            <button class="sidebar-toggle" id="sidebarToggle">
                <i class="fas fa-bars"></i>
            </button>
            <div class="sidebar-content">
                <div class="file-upload">
                    <h3><i class="fas fa-file-excel"></i> Upload File Excel</h3>
                    <input type="file" id="fileInput" accept=".xlsx, .xls" style="display: none;">
                    <label for="fileInput" class="file-upload-btn">
                        <i class="fas fa-upload"></i> Pilih File
                    </label>
                    <div id="fileName" style="margin-top: 10px; font-size: 12px;"></div>
                </div>
                <div class="filter-group">
                    <h3><i class="fas fa-calendar-alt"></i> Date Range</h3>
                    <label for="startDate">Start Date</label>
                    <input type="date" id="startDate">
                    <label for="endDate">End Date</label>
                    <input type="date" id="endDate">
                </div>
                <div class="filter-group">
                    <h3><i class="fas fa-map-marker-alt"></i> Area</h3>
                    <div class="custom-dropdown" id="areaDropdown">
                        <div class="dropdown-selected">
                            <span>Select All</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="dropdown-options">
                            <div class="dropdown-option selected" value="All">Select All</div>
                        </div>
                    </div>
                    <div class="single-option-notice" id="areaNotice" style="display: none;">
                        Hanya satu area tersedia di data
                    </div>
                </div>
                <div class="filter-group">
                    <h3><i class="fas fa-industry"></i> Plant Name</h3>
                    <div class="custom-dropdown" id="plantDropdown">
                        <div class="dropdown-selected">
                            <span>Select All</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="dropdown-options">
                            <div class="dropdown-option selected" value="All">Select All</div>
                        </div>
                    </div>
                </div>
                <div class="filter-group">
                    <h3><i class="fas fa-truck"></i> Truck Type</h3>
                    <div class="custom-dropdown" id="truckTypeDropdown">
                        <div class="dropdown-selected">
                            <span>Select All</span>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                        <div class="dropdown-options">
                            <div class="dropdown-option selected" value="All">Select All</div>
                            <div class="dropdown-option" value="TM Big">TM Big</div>
                            <div class="dropdown-option" value="TM Mini">TM Mini</div>
                        </div>
                    </div>
                </div>
                <div class="toggle-options">
                    <h3><i class="fas fa-toggle-on"></i> Tampilan Chart</h3>
                    <label>
                        <input type="checkbox" id="dataLabelsToggle" checked>
                        Tampilkan Data Labels
                    </label>
                </div>
                <button id="applyFilters" style="width: 100%; padding: 12px; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer;">
                    Apply Filters
                </button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content" id="mainContent">
            <!-- Header -->
            <div class="header">
                <div class="header-content">
                    <h1 id="dashboardTitle">Dashboard Daily Delivery</h1>
                    <div id="lastUpdate">Last Update: <span id="updateTime"></span></div>
                    <div class="header-info">
                        <div id="periodRange">Periode: -</div>
                        <div id="filterInfo">Filter: All Areas, All Plants, All Truck Types</div>
                    </div>
                </div>
            </div>

            <!-- Loading Spinner -->
            <div class="spinner" id="loadingSpinner"></div>

            <!-- Debug Info -->
            <div class="debug-info" id="debugInfo"></div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState">
                <i class="fas fa-file-excel"></i>
                <p>Upload file Excel untuk memulai analisis data</p>
            </div>

            <!-- KPI Cards -->
            <div class="kpi-cards" id="kpiCards" style="display: none;">
                <div class="kpi-card">
                    <h3>Total Area</h3>
                    <div class="value" id="totalArea">0</div>
                </div>
                <div class="kpi-card">
                    <h3>Total Plant</h3>
                    <div class="value" id="totalPlant">0</div>
                </div>
                <div class="kpi-card">
                    <h3>Total Volume</h3>
                    <div class="value" id="totalVolume">0 m³</div>
                    <div class="subtitle" id="totalVolumeSubtitle"></div>
                </div>
                <div class="kpi-card">
                    <h3>Avg Volume</h3>
                    <div class="value" id="avgVolume">0 m³</div>
                    <div class="subtitle" id="avgVolumeSubtitle"></div>
                </div>
                <div class="kpi-card">
                    <h3>Total Truck</h3>
                    <div class="value" id="totalTruck">0</div>
                    <div class="subtitle" id="totalTruckSubtitle"></div>
                </div>
                <div class="kpi-card">
                    <h3>Avg Load/Trip</h3>
                    <div class="value" id="avgLoad">0</div>
                    <div class="subtitle" id="avgLoadSubtitle"></div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs" id="tabs" style="display: none;">
                <button class="tab active" data-tab="logistics">
                    <i class="fas fa-truck"></i> LOGISTIK
                </button>
                <button class="tab" data-tab="sales">
                    <i class="fas fa-chart-line"></i> SALES & CUSTOMER
                </button>
            </div>

            <!-- Logistics Tab -->
            <div class="tab-content active" id="logistics">
                <h2 class="section-title"><i class="fas fa-shipping-fast"></i> Delivery</h2>
                <div class="chart-container" id="volumePerAreaContainer">
                    <h3 class="chart-title"><i class="fas fa-chart-bar"></i> Total Volume per Area</h3>
                    <div class="chart-wrapper"><canvas id="volumePerAreaChart"></canvas></div>
                </div>
                <div class="chart-container" id="volumePerPlantContainer">
                    <h3 class="chart-title"><i class="fas fa-chart-bar"></i> Total Volume per Plant</h3>
                    <div class="chart-wrapper"><canvas id="volumePerPlantChart"></canvas></div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title"><i class="fas fa-chart-line"></i> Average Volume per Plant</h3>
                    <div class="chart-wrapper"><canvas id="avgVolumePerPlantChart"></canvas></div>
                </div>
                <h2 class="section-title"><i class="fas fa-truck-loading"></i> Utilisasi TM</h2>
                <div class="chart-container">
                    <h3 class="chart-title"><i class="fas fa-chart-bar"></i> Total Trip per TM</h3>
                    <div class="chart-wrapper"><canvas id="tripPerTruckChart"></canvas></div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title"><i class="fas fa-chart-bar"></i> Total Volume per TM</h3>
                    <div class="chart-wrapper"><canvas id="volumePerTruckChart"></canvas></div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title"><i class="fas fa-chart-line"></i> Average Load per TM</h3>
                    <div class="chart-wrapper"><canvas id="avgLoadPerTruckChart"></canvas></div>
                </div>
                <h2 class="section-title"><i class="fas fa-route"></i> Distance</h2>
                <div class="chart-container">
                    <h3 class="chart-title"><i class="fas fa-chart-line"></i> Average Distance per Plant</h3>
                    <div class="chart-wrapper"><canvas id="avgDistancePerPlantChart"></canvas></div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title"><i class="fas fa-chart-line"></i> Trend Volume per Distance</h3>
                    <div class="chart-wrapper"><canvas id="volumePerDistanceChart"></canvas></div>
                </div>
            </div>

            <!-- Sales & Customer Tab -->
            <div class="tab-content" id="sales">
                <div class="chart-container">
                    <h3 class="chart-title"><i class="fas fa-user-tie"></i> Volume per Sales</h3>
                    <div class="chart-wrapper"><canvas id="volumePerSalesChart"></canvas></div>
                </div>
                <div class="chart-container">
                    <h3 class="chart-title"><i class="fas fa-users"></i> Top 30 Customers by Volume</h3>
                    <div class="chart-wrapper"><canvas id="volumePerCustomerChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">Dashboard Daily Delivery by L=23-52Xe</footer>

    <script>
        // ================= Global Variables =================
        let rawData = [];
        let filteredData = [];
        let charts = {};
        let showDataLabels = true;

        document.getElementById('updateTime').textContent = new Date().toLocaleString();

        // Listeners
        document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);
        document.getElementById('applyFilters').addEventListener('click', applyFilters);
        document.getElementById('dataLabelsToggle').addEventListener('change', function () {
            showDataLabels = this.checked;
            if (filteredData.length > 0) {
                updateCharts();
            }
        });

        setupDropdown('areaDropdown');
        setupDropdown('plantDropdown');
        setupDropdown('truckTypeDropdown');

        // Tabs switching
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', function () {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
                document.getElementById(this.dataset.tab).classList.add('active');
            });
        });

        // ============ APPLY FILTERS (fixed) ============
        function applyFilters() {
            const startDate = new Date(document.getElementById('startDate').value);
            const endDate = new Date(document.getElementById('endDate').value);
            endDate.setHours(23, 59, 59);

            // Get selected filters
            const areaOptions = document.querySelector('#areaDropdown .dropdown-options');
            const selectedAreas = Array.from(areaOptions.querySelectorAll('.dropdown-option.selected')).map(o => o.value);
            const allAreasSelected = selectedAreas.includes('All') || selectedAreas.length === 0;

            const plantOptions = document.querySelector('#plantDropdown .dropdown-options');
            const selectedPlants = Array.from(plantOptions.querySelectorAll('.dropdown-option.selected')).map(o => o.value);
            const allPlantsSelected = selectedPlants.includes('All') || selectedPlants.length === 0;

            const truckTypeOptions = document.querySelector('#truckTypeDropdown .dropdown-options');
            const selectedTruckTypes = Array.from(truckTypeOptions.querySelectorAll('.dropdown-option.selected')).map(o => o.value);
            const allTruckTypesSelected = selectedTruckTypes.includes('All') || selectedTruckTypes.length === 0;

            // Filter data
            filteredData = rawData.filter(item => {
                const itemDate = new Date(item['DP Date']);
                return (
                    itemDate >= startDate && itemDate <= endDate &&
                    (allAreasSelected || selectedAreas.includes(item.Area)) &&
                    (allPlantsSelected || selectedPlants.includes(item['Plant Name'])) &&
                    (allTruckTypesSelected || selectedTruckTypes.includes(item['Truck Type']))
                );
            });

            // Title
            if (allAreasSelected) {
                document.getElementById('dashboardTitle').textContent = 'Dashboard Daily Delivery - All Area';
            } else if (selectedAreas.length === 1) {
                document.getElementById('dashboardTitle').textContent = `Dashboard Daily Delivery - ${selectedAreas[0]}`;
            } else {
                document.getElementById('dashboardTitle').textContent = `Dashboard Daily Delivery - ${selectedAreas.length} Areas`;
            }

            // Filter info
            updateFilterInfo(selectedAreas, selectedPlants, selectedTruckTypes, allAreasSelected, allPlantsSelected, allTruckTypesSelected);

            // Period & update time
            document.getElementById('periodRange').textContent = `Periode: ${formatDate(startDate)} - ${formatDate(endDate)}`;
            document.getElementById('updateTime').textContent = new Date().toLocaleString();

            // Always show charts (no hide)
            updateChartVisibility();

            // Update KPIs & charts
            updateKPIs();
            updateCharts();
        }
        // ============ Update Chart Visibility (fixed) ============
        function updateChartVisibility() {
            document.getElementById('volumePerAreaContainer').style.display = 'block';
            document.getElementById('volumePerPlantContainer').style.display = 'block';
        }

        // ============ Helpers & Functions ============

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        }

        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            document.getElementById('fileName').textContent = file.name;

            const reader = new FileReader();
            reader.onload = function (evt) {
                const data = new Uint8Array(evt.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const sheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(sheet);
                rawData = jsonData;
                filteredData = jsonData;

                document.getElementById('emptyState').style.display = 'none';
                document.getElementById('kpiCards').style.display = 'grid';
                document.getElementById('tabs').style.display = 'flex';

                updateDateFilters();
                updateFilters();
                updateKPIs();
                updateCharts();
            };
            reader.readAsArrayBuffer(file);
        }

        function updateDateFilters() {
            if (rawData.length === 0) return;
            const dates = rawData.map(r => new Date(r['DP Date']));
            const minDate = new Date(Math.min(...dates));
            const maxDate = new Date(Math.max(...dates));

            document.getElementById('startDate').valueAsDate = minDate;
            document.getElementById('endDate').valueAsDate = maxDate;
        }

        function updateFilters() {
            const areas = [...new Set(rawData.map(r => r.Area))];
            const plants = [...new Set(rawData.map(r => r['Plant Name']))];

            const areaOptions = document.querySelector('#areaDropdown .dropdown-options');
            areaOptions.innerHTML = '<div class="dropdown-option selected" value="All">Select All</div>';
            areas.forEach(a => {
                const div = document.createElement('div');
                div.className = 'dropdown-option';
                div.setAttribute('value', a);
                div.textContent = a;
                areaOptions.appendChild(div);
            });

            const plantOptions = document.querySelector('#plantDropdown .dropdown-options');
            plantOptions.innerHTML = '<div class="dropdown-option selected" value="All">Select All</div>';
            plants.forEach(p => {
                const div = document.createElement('div');
                div.className = 'dropdown-option';
                div.setAttribute('value', p);
                div.textContent = p;
                plantOptions.appendChild(div);
            });
        }

        function updateFilterInfo(areas, plants, trucks, allA, allP, allT) {
            const areaText = allA ? 'All Areas' : areas.join(', ');
            const plantText = allP ? 'All Plants' : plants.join(', ');
            const truckText = allT ? 'All Truck Types' : trucks.join(', ');
            document.getElementById('filterInfo').textContent = `Filter: ${areaText}, ${plantText}, ${truckText}`;
        }

        function updateKPIs() {
            if (filteredData.length === 0) {
                document.getElementById('totalArea').textContent = 0;
                document.getElementById('totalPlant').textContent = 0;
                document.getElementById('totalVolume').textContent = '0 m³';
                document.getElementById('avgVolume').textContent = '0 m³';
                document.getElementById('totalTruck').textContent = 0;
                document.getElementById('avgLoad').textContent = 0;
                return;
            }

            const areas = [...new Set(filteredData.map(r => r.Area))];
            const plants = [...new Set(filteredData.map(r => r['Plant Name']))];
            const totalVolume = filteredData.reduce((sum, r) => sum + (r.QTY || 0), 0);
            const avgVolume = totalVolume / filteredData.length;
            const trucks = [...new Set(filteredData.map(r => r['Truck No']))];
            const avgLoad = totalVolume / (filteredData.length || 1);

            document.getElementById('totalArea').textContent = areas.length;
            document.getElementById('totalPlant').textContent = plants.length;
            document.getElementById('totalVolume').textContent = `${totalVolume.toFixed(0)} m³`;
            document.getElementById('avgVolume').textContent = `${avgVolume.toFixed(1)} m³`;
            document.getElementById('totalTruck').textContent = trucks.length;
            document.getElementById('avgLoad').textContent = avgLoad.toFixed(1);
        }

        function updateCharts() {
            if (Object.keys(charts).length > 0) {
                Object.values(charts).forEach(c => c.destroy());
            }
            if (filteredData.length === 0) return;

            const chartData = calculateChartData();
            initCharts(chartData);
        }

        function calculateChartData() {
            const areas = {};
            const plants = {};
            const trucks = {};
            const sales = {};
            const customers = {};

            filteredData.forEach(r => {
                areas[r.Area] = (areas[r.Area] || 0) + (r.QTY || 0);
                plants[r['Plant Name']] = (plants[r['Plant Name']] || 0) + (r.QTY || 0);
                trucks[r['Truck No']] = (trucks[r['Truck No']] || 0) + (r.QTY || 0);
                sales[r.Sales] = (sales[r.Sales] || 0) + (r.QTY || 0);
                customers[r.Customer] = (customers[r.Customer] || 0) + (r.QTY || 0);
            });

            return {
                areas: Object.entries(areas),
                plants: Object.entries(plants),
                trucks: Object.entries(trucks),
                sales: Object.entries(sales),
                customers: Object.entries(customers).sort((a, b) => b[1] - a[1]).slice(0, 30)
            };
        }

        function initCharts(data) {
            const ctxArea = document.getElementById('volumePerAreaChart').getContext('2d');
            charts.area = new Chart(ctxArea, {
                type: 'bar',
                data: {
                    labels: data.areas.map(d => d[0]),
                    datasets: [{
                        label: 'Volume',
                        data: data.areas.map(d => d[1]),
                        backgroundColor: '#3498db'
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });

            const ctxPlant = document.getElementById('volumePerPlantChart').getContext('2d');
            charts.plant = new Chart(ctxPlant, {
                type: 'bar',
                data: {
                    labels: data.plants.map(d => d[0]),
                    datasets: [{
                        label: 'Volume',
                        data: data.plants.map(d => d[1]),
                        backgroundColor: '#2ecc71'
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });

            const ctxSales = document.getElementById('volumePerSalesChart').getContext('2d');
            charts.sales = new Chart(ctxSales, {
                type: 'bar',
                data: {
                    labels: data.sales.map(d => d[0]),
                    datasets: [{
                        label: 'Volume',
                        data: data.sales.map(d => d[1]),
                        backgroundColor: '#9b59b6'
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });

            const ctxCust = document.getElementById('volumePerCustomerChart').getContext('2d');
            charts.customer = new Chart(ctxCust, {
                type: 'bar',
                data: {
                    labels: data.customers.map(d => d[0]),
                    datasets: [{
                        label: 'Volume',
                        data: data.customers.map(d => d[1]),
                        backgroundColor: '#e67e22'
                    }]
                },
                options: { responsive: true, plugins: { legend: { display: false } } }
            });
        }

        function setupDropdown(id) {
            const dropdown = document.getElementById(id);
            const selected = dropdown.querySelector('.dropdown-selected');
            const options = dropdown.querySelector('.dropdown-options');

            selected.addEventListener('click', () => {
                options.classList.toggle('show');
            });

            options.addEventListener('click', e => {
                if (!e.target.classList.contains('dropdown-option')) return;
                if (e.target.getAttribute('value') === 'All') {
                    options.querySelectorAll('.dropdown-option').forEach(opt => opt.classList.remove('selected'));
                    e.target.classList.add('selected');
                    selected.querySelector('span').textContent = 'Select All';
                } else {
                    e.target.classList.toggle('selected');
                    const selectedOptions = options.querySelectorAll('.dropdown-option.selected:not([value="All"])');
                    if (selectedOptions.length > 0) {
                        options.querySelector('.dropdown-option[value="All"]').classList.remove('selected');
                        selected.querySelector('span').textContent = `${selectedOptions.length} selected`;
                    } else {
                        options.querySelector('.dropdown-option[value="All"]').classList.add('selected');
                        selected.querySelector('span').textContent = 'Select All';
                    }
                }
            });
        }

        function formatDate(d) {
            return d.toISOString().split('T')[0];
        }
    </script>
</body>
</html>
